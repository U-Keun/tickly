name: CD

on:
  push:
    tags: ["v*.*.*"]
  workflow_dispatch:
    inputs:
      build_ios:
        description: Build and upload iOS app to TestFlight
        required: true
        type: boolean
        default: true
      build_desktop:
        description: Build desktop bundles (macOS, Windows, Linux)
        required: true
        type: boolean
        default: true
      create_release:
        description: Create GitHub draft release with desktop artifacts
        required: true
        type: boolean
        default: true

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  validate-release-version:
    name: Validate Release Version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Validate package/Tauri version and git tag
        env:
          GITHUB_REF: ${{ github.ref }}
        run: |
          node <<'NODE'
          const fs = require('fs');

          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          const tauri = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf8'));
          const ref = process.env.GITHUB_REF ?? '';
          const isTagRef = ref.startsWith('refs/tags/');
          const tag = isTagRef ? ref.replace('refs/tags/', '') : '';
          const normalizedTag = tag.startsWith('v') ? tag.slice(1) : tag;

          if (pkg.version !== tauri.version) {
            console.error(`Version mismatch: package.json=${pkg.version}, tauri.conf.json=${tauri.version}`);
            process.exit(1);
          }

          if (isTagRef && normalizedTag !== pkg.version) {
            console.error(`Tag version mismatch: git tag=${tag}, app version=${pkg.version}`);
            process.exit(1);
          }

          console.log(`Version validation OK: ${pkg.version}`);
          NODE

  preflight-desktop:
    name: Preflight Desktop Secrets
    runs-on: ubuntu-latest
    needs: [validate-release-version]
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.build_desktop)
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    steps:
      - name: Ensure required secrets exist
        run: |
          missing=()
          [[ -n "${SUPABASE_URL}" ]] || missing+=("SUPABASE_URL")
          [[ -n "${SUPABASE_ANON_KEY}" ]] || missing+=("SUPABASE_ANON_KEY")

          if [ ${#missing[@]} -gt 0 ]; then
            echo "Missing required secrets: ${missing[*]}"
            exit 1
          fi

  preflight-ios:
    name: Preflight iOS Secrets
    runs-on: ubuntu-latest
    needs: [validate-release-version]
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.build_ios)
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      IOS_CERTIFICATE_P12: ${{ secrets.IOS_CERTIFICATE_P12 }}
      IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
      IOS_PROVISIONING_PROFILE: ${{ secrets.IOS_PROVISIONING_PROFILE }}
      APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
      APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
    steps:
      - name: Ensure required secrets exist
        run: |
          missing=()
          [[ -n "${SUPABASE_URL}" ]] || missing+=("SUPABASE_URL")
          [[ -n "${SUPABASE_ANON_KEY}" ]] || missing+=("SUPABASE_ANON_KEY")
          [[ -n "${IOS_CERTIFICATE_P12}" ]] || missing+=("IOS_CERTIFICATE_P12")
          [[ -n "${IOS_CERTIFICATE_PASSWORD}" ]] || missing+=("IOS_CERTIFICATE_PASSWORD")
          [[ -n "${IOS_PROVISIONING_PROFILE}" ]] || missing+=("IOS_PROVISIONING_PROFILE")
          [[ -n "${APP_STORE_CONNECT_API_ISSUER_ID}" ]] || missing+=("APP_STORE_CONNECT_API_ISSUER_ID")
          [[ -n "${APP_STORE_CONNECT_API_KEY_ID}" ]] || missing+=("APP_STORE_CONNECT_API_KEY_ID")
          [[ -n "${APP_STORE_CONNECT_API_KEY_CONTENT}" ]] || missing+=("APP_STORE_CONNECT_API_KEY_CONTENT")

          if [ ${#missing[@]} -gt 0 ]; then
            echo "Missing required secrets: ${missing[*]}"
            exit 1
          fi

  build-ios:
    name: Build iOS (TestFlight)
    runs-on: macos-latest
    needs: [preflight-ios]
    if: needs.preflight-ios.result == 'success'
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      IOS_CERTIFICATE: ${{ secrets.IOS_CERTIFICATE_P12 }}
      IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
      IOS_MOBILE_PROVISION: ${{ secrets.IOS_PROVISIONING_PROFILE }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      - run: yarn install --frozen-lockfile

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
          key: cargo-ios-${{ hashFiles('src-tauri/Cargo.lock') }}
          restore-keys: cargo-ios-

      - name: Build frontend (required for iOS)
        run: yarn build

      - name: Extract development team from provisioning profile
        run: |
          PROFILE_PATH=$RUNNER_TEMP/profile.mobileprovision
          echo -n "$IOS_MOBILE_PROVISION" | base64 --decode > "$PROFILE_PATH"

          security cms -D -i "$PROFILE_PATH" > "$RUNNER_TEMP/profile.plist"
          TEAM_ID=$(/usr/libexec/PlistBuddy -c "Print :TeamIdentifier:0" "$RUNNER_TEMP/profile.plist")
          if [ -z "$TEAM_ID" ]; then
            echo "Failed to extract TeamIdentifier from provisioning profile"
            exit 1
          fi
          echo "APPLE_DEVELOPMENT_TEAM=$TEAM_ID" >> $GITHUB_ENV

      - name: Initialize iOS project
        run: yarn tauri ios init --ci

      - name: Build iOS
        run: yarn tauri ios build --ci --export-method app-store-connect

      - name: Find IPA file
        id: find-ipa
        run: |
          IPA_PATH=$(find src-tauri/gen/apple -name "*.ipa" -type f | head -1)
          if [ -z "$IPA_PATH" ]; then
            echo "No IPA file found in src-tauri/gen/apple"
            exit 1
          fi
          echo "ipa_path=$IPA_PATH" >> $GITHUB_OUTPUT
          echo "Found IPA: $IPA_PATH"

      - uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: ${{ steps.find-ipa.outputs.ipa_path }}
          retention-days: 7

      - name: Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: ${{ steps.find-ipa.outputs.ipa_path }}
          issuer-id: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          api-key-id: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          api-private-key: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}

      - name: Cleanup keychain
        if: always()
        run: security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true

  build-desktop:
    name: Build Desktop (${{ matrix.platform }})
    needs: [preflight-desktop]
    if: needs.preflight-desktop.result == 'success'
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos
            runner: macos-latest
            artifact-glob: |
              src-tauri/target/release/bundle/dmg/*.dmg
          - platform: windows
            runner: windows-latest
            artifact-glob: |
              src-tauri/target/release/bundle/msi/*.msi
              src-tauri/target/release/bundle/nsis/*.exe
          - platform: linux
            runner: ubuntu-latest
            artifact-glob: |
              src-tauri/target/release/bundle/deb/*.deb
              src-tauri/target/release/bundle/appimage/*.AppImage
    runs-on: ${{ matrix.runner }}
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      - run: yarn install --frozen-lockfile

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libssl-dev

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
          key: cargo-${{ matrix.platform }}-${{ hashFiles('src-tauri/Cargo.lock') }}
          restore-keys: cargo-${{ matrix.platform }}-

      - run: yarn tauri build

      - uses: actions/upload-artifact@v4
        with:
          name: desktop-${{ matrix.platform }}
          path: ${{ matrix.artifact-glob }}
          retention-days: 7

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-desktop]
    if: startsWith(github.ref, 'refs/tags/v') && (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.create_release)) && needs.build-desktop.result == 'success'
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: find artifacts -type f | sort

      - uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*
          generate_release_notes: true
          draft: true
