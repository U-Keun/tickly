name: CD

on:
  push:
    tags: ["v*.*.*"]
  workflow_dispatch:
    inputs:
      build_ios:
        description: Build and upload iOS app to TestFlight
        required: true
        type: boolean
        default: true
      build_desktop:
        description: Build desktop bundles (macOS, Windows, Linux)
        required: true
        type: boolean
        default: true
      create_release:
        description: Create GitHub draft release with desktop artifacts
        required: true
        type: boolean
        default: true

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  validate-release-version:
    name: Validate Release Version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Validate package/Tauri version and git tag
        env:
          GITHUB_REF: ${{ github.ref }}
        run: |
          node <<'NODE'
          const fs = require('fs');

          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          const tauri = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf8'));
          const ref = process.env.GITHUB_REF ?? '';
          const isTagRef = ref.startsWith('refs/tags/');
          const tag = isTagRef ? ref.replace('refs/tags/', '') : '';
          const normalizedTag = tag.startsWith('v') ? tag.slice(1) : tag;

          if (pkg.version !== tauri.version) {
            console.error(`Version mismatch: package.json=${pkg.version}, tauri.conf.json=${tauri.version}`);
            process.exit(1);
          }

          if (isTagRef && normalizedTag !== pkg.version) {
            console.error(`Tag version mismatch: git tag=${tag}, app version=${pkg.version}`);
            process.exit(1);
          }

          console.log(`Version validation OK: ${pkg.version}`);
          NODE

  preflight-desktop:
    name: Preflight Desktop Secrets
    runs-on: ubuntu-latest
    needs: [validate-release-version]
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.build_desktop)
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    steps:
      - name: Ensure required secrets exist
        run: |
          missing=()
          [[ -n "${SUPABASE_URL}" ]] || missing+=("SUPABASE_URL")
          [[ -n "${SUPABASE_ANON_KEY}" ]] || missing+=("SUPABASE_ANON_KEY")

          if [ ${#missing[@]} -gt 0 ]; then
            echo "Missing required secrets: ${missing[*]}"
            exit 1
          fi

  preflight-ios:
    name: Preflight iOS Secrets
    runs-on: ubuntu-latest
    needs: [validate-release-version]
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.build_ios)
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      IOS_CERTIFICATE_P12: ${{ secrets.IOS_CERTIFICATE_P12 }}
      IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
      IOS_PROVISIONING_PROFILE: ${{ secrets.IOS_PROVISIONING_PROFILE }}
      APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
      APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
    steps:
      - name: Ensure required secrets exist
        run: |
          missing=()
          [[ -n "${SUPABASE_URL}" ]] || missing+=("SUPABASE_URL")
          [[ -n "${SUPABASE_ANON_KEY}" ]] || missing+=("SUPABASE_ANON_KEY")
          [[ -n "${IOS_CERTIFICATE_P12}" ]] || missing+=("IOS_CERTIFICATE_P12")
          [[ -n "${IOS_CERTIFICATE_PASSWORD}" ]] || missing+=("IOS_CERTIFICATE_PASSWORD")
          [[ -n "${IOS_PROVISIONING_PROFILE}" ]] || missing+=("IOS_PROVISIONING_PROFILE")
          [[ -n "${APP_STORE_CONNECT_API_ISSUER_ID}" ]] || missing+=("APP_STORE_CONNECT_API_ISSUER_ID")
          [[ -n "${APP_STORE_CONNECT_API_KEY_ID}" ]] || missing+=("APP_STORE_CONNECT_API_KEY_ID")
          [[ -n "${APP_STORE_CONNECT_API_KEY_CONTENT}" ]] || missing+=("APP_STORE_CONNECT_API_KEY_CONTENT")

          if [ ${#missing[@]} -gt 0 ]; then
            echo "Missing required secrets: ${missing[*]}"
            exit 1
          fi

  build-ios:
    name: Build iOS (TestFlight)
    runs-on: macos-latest
    needs: [preflight-ios]
    if: needs.preflight-ios.result == 'success'
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      IOS_CERTIFICATE: ${{ secrets.IOS_CERTIFICATE_P12 }}
      IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
      IOS_MOBILE_PROVISION: ${{ secrets.IOS_PROVISIONING_PROFILE }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      - run: yarn install --frozen-lockfile

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
          key: cargo-ios-${{ hashFiles('src-tauri/Cargo.lock') }}
          restore-keys: cargo-ios-

      - name: Build frontend (required for iOS)
        run: yarn build

      - name: Import signing certificate to keychain
        run: |
          CERT_PATH="$RUNNER_TEMP/certificate.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          KEYCHAIN_PASSWORD=$(openssl rand -hex 16)

          echo "IOS_KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV
          echo "IOS_KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

          echo -n "$IOS_CERTIFICATE" | base64 --decode > "$CERT_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -P "$IOS_CERTIFICATE_PASSWORD" -A -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" /Users/runner/Library/Keychains/login.keychain-db
          security default-keychain -d user -s "$KEYCHAIN_PATH"
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

      - name: Validate provisioning profile for App Store export
        run: |
          PROFILE_PATH=$RUNNER_TEMP/profile.mobileprovision
          echo -n "$IOS_MOBILE_PROVISION" | base64 --decode > "$PROFILE_PATH"
          security cms -D -i "$PROFILE_PATH" > "$RUNNER_TEMP/profile.plist"

          TEAM_ID=$(/usr/libexec/PlistBuddy -c "Print :TeamIdentifier:0" "$RUNNER_TEMP/profile.plist")
          if [ -z "$TEAM_ID" ]; then
            echo "Failed to extract TeamIdentifier from provisioning profile"
            exit 1
          fi
          echo "APPLE_DEVELOPMENT_TEAM=$TEAM_ID" >> $GITHUB_ENV

          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c "Print :UUID" "$RUNNER_TEMP/profile.plist")
          if [ -z "$PROFILE_UUID" ]; then
            echo "Failed to extract UUID from provisioning profile"
            exit 1
          fi
          echo "IOS_PROFILE_UUID=$PROFILE_UUID" >> $GITHUB_ENV

          PROFILE_NAME=$(/usr/libexec/PlistBuddy -c "Print :Name" "$RUNNER_TEMP/profile.plist")
          if [ -z "$PROFILE_NAME" ]; then
            echo "Failed to extract Name from provisioning profile"
            exit 1
          fi
          echo "IOS_PROFILE_NAME=$PROFILE_NAME" >> $GITHUB_ENV

          # TestFlight/App Store export needs a distribution profile (not development).
          GET_TASK_ALLOW=$(/usr/libexec/PlistBuddy -c "Print :Entitlements:get-task-allow" "$RUNNER_TEMP/profile.plist" 2>/dev/null || echo "unknown")
          if [ "$GET_TASK_ALLOW" = "true" ]; then
            echo "Provided IOS_PROVISIONING_PROFILE appears to be a Development profile."
            echo "Use an App Store / Distribution provisioning profile for TestFlight export."
            exit 1
          fi

          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp "$PROFILE_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Initialize iOS project
        run: yarn tauri ios init --ci

      - name: Configure Xcode signing with provisioning profile
        run: |
          PBXPROJ="src-tauri/gen/apple/tickly.xcodeproj/project.pbxproj"

          set_or_add() {
            path="$1"
            value="$2"
            /usr/libexec/PlistBuddy -c "Set $path \"$value\"" "$PBXPROJ" 2>/dev/null || \
              /usr/libexec/PlistBuddy -c "Add $path string \"$value\"" "$PBXPROJ"
          }

          CONFIG_IDS=$(/usr/libexec/PlistBuddy -c "Print :objects" "$PBXPROJ" | awk '/ = Dict/ {k=$1} /isa = XCBuildConfiguration/ {gsub("=", "", k); print k}')
          for id in $CONFIG_IDS; do
            bundle_id=$(/usr/libexec/PlistBuddy -c "Print :objects:$id:buildSettings:PRODUCT_BUNDLE_IDENTIFIER" "$PBXPROJ" 2>/dev/null || true)
            if [ "$bundle_id" = "com.u-keunsong.tickly" ]; then
              set_or_add ":objects:$id:buildSettings:CODE_SIGN_STYLE" "Manual"
              set_or_add ":objects:$id:buildSettings:DEVELOPMENT_TEAM" "$APPLE_DEVELOPMENT_TEAM"
              set_or_add ":objects:$id:buildSettings:CODE_SIGN_IDENTITY" "Apple Distribution"
              set_or_add ":objects:$id:buildSettings:PROVISIONING_PROFILE" "$IOS_PROFILE_UUID"
              set_or_add ":objects:$id:buildSettings:PROVISIONING_PROFILE_SPECIFIER" "$IOS_PROFILE_NAME"
              set_or_add ":objects:$id:buildSettings:SUPPORTS_MAC_DESIGNED_FOR_IPHONE_IPAD" "NO"
              set_or_add ":objects:$id:buildSettings:SUPPORTED_PLATFORMS" "iphoneos iphonesimulator"
            fi
          done

      - name: Ensure iOS URL scheme for OAuth callback
        run: |
          INFO_PLIST="src-tauri/gen/apple/tickly_iOS/Info.plist"
          /usr/libexec/PlistBuddy -c "Delete :CFBundleURLTypes" "$INFO_PLIST" 2>/dev/null || true
          /usr/libexec/PlistBuddy -c "Add :CFBundleURLTypes array" "$INFO_PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleURLTypes:0 dict" "$INFO_PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleURLTypes:0:CFBundleURLName string com.u-keunsong.tickly" "$INFO_PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleURLTypes:0:CFBundleURLSchemes array" "$INFO_PLIST"
          /usr/libexec/PlistBuddy -c "Add :CFBundleURLTypes:0:CFBundleURLSchemes:0 string tickly" "$INFO_PLIST"

      - name: Archive iOS app (xcodebuild)
        run: |
          ARCHIVE_PATH="$RUNNER_TEMP/tickly_iOS.xcarchive"
          echo "IOS_ARCHIVE_PATH=$ARCHIVE_PATH" >> $GITHUB_ENV

          xcodebuild \
            -workspace src-tauri/gen/apple/tickly.xcodeproj/project.xcworkspace \
            -scheme tickly_iOS \
            -configuration Release \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            -archivePath "$ARCHIVE_PATH" \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="$APPLE_DEVELOPMENT_TEAM" \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            'CODE_SIGN_IDENTITY[sdk=iphoneos*]=Apple Distribution' \
            PROVISIONING_PROFILE_SPECIFIER="$IOS_PROFILE_NAME" \
            PROVISIONING_PROFILE="$IOS_PROFILE_UUID" \
            archive

      - name: Export iOS IPA (xcodebuild)
        run: |
          EXPORT_PATH="$RUNNER_TEMP/ios-export"
          EXPORT_OPTIONS_PLIST="$RUNNER_TEMP/ExportOptions.plist"
          echo "IOS_EXPORT_PATH=$EXPORT_PATH" >> $GITHUB_ENV

          cat > "$EXPORT_OPTIONS_PLIST" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>release-testing</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>teamID</key>
            <string>${APPLE_DEVELOPMENT_TEAM}</string>
            <key>signingCertificate</key>
            <string>Apple Distribution</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>com.u-keunsong.tickly</key>
              <string>${IOS_PROFILE_NAME}</string>
            </dict>
          </dict>
          </plist>
          EOF

          xcodebuild \
            -exportArchive \
            -archivePath "$IOS_ARCHIVE_PATH" \
            -exportPath "$EXPORT_PATH" \
            -exportOptionsPlist "$EXPORT_OPTIONS_PLIST"

      - name: Debug iOS signing settings (on failure)
        if: failure()
        run: |
          set +e
          xcodebuild -workspace src-tauri/gen/apple/tickly.xcodeproj/project.xcworkspace -scheme tickly_iOS -showBuildSettings | egrep "PRODUCT_BUNDLE_IDENTIFIER|DEVELOPMENT_TEAM|CODE_SIGN_STYLE|CODE_SIGN_IDENTITY|PROVISIONING_PROFILE"
          security find-identity -v -p codesigning "$IOS_KEYCHAIN_PATH"

      - name: Debug iOS export logs (on failure)
        if: failure()
        run: |
          set +e
          LOG_DIR=$(ls -td /var/folders/*/*/*/T/*.xcdistributionlogs 2>/dev/null | head -1)
          echo "Latest xcdistributionlogs: ${LOG_DIR:-not found}"
          if [ -n "$LOG_DIR" ]; then
            find "$LOG_DIR" -type f | sort
            find "$LOG_DIR" -type f -name "*.log" -print -exec tail -n 200 {} \;
          fi

      - name: Find IPA file
        id: find-ipa
        run: |
          IPA_PATH=$(find "$IOS_EXPORT_PATH" -name "*.ipa" -type f | head -1)
          if [ -z "$IPA_PATH" ]; then
            echo "No IPA file found in $IOS_EXPORT_PATH"
            exit 1
          fi
          echo "ipa_path=$IPA_PATH" >> $GITHUB_OUTPUT
          echo "Found IPA: $IPA_PATH"

      - uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: ${{ steps.find-ipa.outputs.ipa_path }}
          retention-days: 7

      - name: Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: ${{ steps.find-ipa.outputs.ipa_path }}
          issuer-id: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          api-key-id: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          api-private-key: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}

      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain "$IOS_KEYCHAIN_PATH" || true

  build-desktop:
    name: Build Desktop (${{ matrix.platform }})
    needs: [preflight-desktop]
    if: needs.preflight-desktop.result == 'success'
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos
            runner: macos-latest
            artifact-glob: |
              src-tauri/target/release/bundle/dmg/*.dmg
          - platform: windows
            runner: windows-latest
            artifact-glob: |
              src-tauri/target/release/bundle/msi/*.msi
              src-tauri/target/release/bundle/nsis/*.exe
          - platform: linux
            runner: ubuntu-latest
            artifact-glob: |
              src-tauri/target/release/bundle/deb/*.deb
              src-tauri/target/release/bundle/appimage/*.AppImage
    runs-on: ${{ matrix.runner }}
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      - run: yarn install --frozen-lockfile

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libssl-dev

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
          key: cargo-${{ matrix.platform }}-${{ hashFiles('src-tauri/Cargo.lock') }}
          restore-keys: cargo-${{ matrix.platform }}-

      - run: yarn tauri build

      - uses: actions/upload-artifact@v4
        with:
          name: desktop-${{ matrix.platform }}
          path: ${{ matrix.artifact-glob }}
          retention-days: 7

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-desktop]
    if: startsWith(github.ref, 'refs/tags/v') && (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.create_release)) && needs.build-desktop.result == 'success'
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: find artifacts -type f | sort

      - uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*
          generate_release_notes: true
          draft: true
